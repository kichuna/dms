{% extends "base.html" %}

{% block content %}
<h2>Program Indicators</h2>

<!-- Controls Container -->
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
    <!-- Program Type Selector -->
    <div class="program-selector">
        <button class="tab-btn active" onclick="switchProgram('education')"
            style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; margin-right: 10px;">
            Education Support
        </button>
        <button class="tab-btn" onclick="switchProgram('family')"
            style="padding: 8px 15px; background-color: #f0f0f0; color: #333; border: none; border-radius: 5px;">
            Family Support
        </button>
    </div>

    <!-- Add New Entry Button (Admin Only) -->
    {% if current_user.role == 'admin' %}
    <div>
        <a href="{{ url_for('data_manager') }}" class="btn btn-success" style="margin-right: 10px;">Add Education
            Support Data</a>
        <a href="{{ url_for('add_family_program_data') }}" class="btn btn-success">Add Family Support Data</a>
    </div>
    {% endif %}
</div>

<!-- Education Support Program -->
<div id="education-program" class="program-section">
    <h3>Education Support Program Indicators</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>High School</th>
                    <th>College</th>
                    <th>Scholarship</th>
                    <th>Transport</th>
                    <th>Upkeep</th>
                    <th>Materials</th>
                    <th>Pocket Money</th>
                    <th>Tuition</th>
                    {% if current_user.role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for indicator in education_indicators %}
                <tr data-id="{{ indicator.id }}">
                    <td>{{ indicator.date_column if indicator.date_column else 'N/A' }}</td>
                    <td><span class="display-value">{{ indicator.enrolled_in_high_school }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.enrolled_in_high_school }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.enrolled_in_college }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.enrolled_in_college }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.continued_scholarship_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.continued_scholarship_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.supported_with_transport }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.supported_with_transport }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.supported_with_upkeep }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.supported_with_upkeep }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.supported_with_scholastic_materials }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.supported_with_scholastic_materials }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.supported_with_pocket_money }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.supported_with_pocket_money }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.supported_with_tuition }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.supported_with_tuition }}">
                        {% endif %}
                    </td>
                    {% if current_user.role == 'admin' %}
                    <td>
                        <button onclick="editRow(this)" class="btn btn-sm btn-primary">Edit</button>
                        <button onclick="saveRow(this, 'education')" class="btn btn-sm btn-success"
                            style="display: none;">Save</button>
                        <button onclick="deleteRow(this, 'education')" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Family Support Program -->
<div id="family-program" class="program-section" style="display: none;">
    <h3>Family Support Program Indicators</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Financial</th>
                    <th>Housing</th>
                    <th>Healthcare</th>
                    <th>Food</th>
                    <th>Education</th>
                    <th>Employment</th>
                    <th>Emotional</th>
                    <th>Legal</th>
                    {% if current_user.role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for indicator in family_indicators %}
                <tr data-id="{{ indicator.id }}">
                    <td>{{ indicator.date_column if indicator.date_column else 'N/A' }}</td>
                    <td><span class="display-value">{{ indicator.financial_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.financial_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.housing_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.housing_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.healthcare_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.healthcare_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.food_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.food_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.educational_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.educational_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.employment_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.employment_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.emotional_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.emotional_support }}">
                        {% endif %}
                    </td>
                    <td><span class="display-value">{{ indicator.legal_support }}</span>
                        {% if current_user.role == 'admin' %}
                        <input type="number" class="edit-input" style="display: none;"
                            value="{{ indicator.legal_support }}">
                        {% endif %}
                    </td>
                    {% if current_user.role == 'admin' %}
                    <td>
                        <button onclick="editRow(this)" class="btn btn-sm btn-primary">Edit</button>
                        <button onclick="saveRow(this, 'family')" class="btn btn-sm btn-success"
                            style="display: none;">Save</button>
                        <button onclick="deleteRow(this, 'family')" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function switchProgram(program) {
        // Hide all program sections
        document.querySelectorAll('.program-section').forEach(section => {
            section.style.display = 'none';
        });

        // Show selected program section
        document.getElementById(program + '-program').style.display = 'block';

        // Update button styles
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.style.backgroundColor = '#f0f0f0';
            btn.style.color = '#333';
        });
        event.target.style.backgroundColor = '#4CAF50';
        event.target.style.color = 'white';
    }

    function editRow(button) {
        const row = button.closest('tr');
        row.querySelectorAll('.display-value').forEach(span => span.style.display = 'none');
        row.querySelectorAll('.edit-input').forEach(input => input.style.display = '');
        button.style.display = 'none';
        button.nextElementSibling.style.display = '';
    }

    function saveRow(button, program) {
        const row = button.closest('tr');
        const id = row.dataset.id;
        const inputs = Array.from(row.querySelectorAll('.edit-input'));
        const values = inputs.map(input => parseInt(input.value) || 0);

        fetch('/update_indicator', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: id,
                program: program,
                values: values
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    inputs.forEach((input, index) => {
                        const span = input.previousElementSibling;
                        span.textContent = input.value;
                        span.style.display = '';
                        input.style.display = 'none';
                    });
                    button.style.display = 'none';
                    button.previousElementSibling.style.display = '';
                } else {
                    alert('Error updating record: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating record');
            });
    }

    function deleteRow(button, program) {
        if (!confirm('Are you sure you want to delete this record?')) {
            return;
        }

        const row = button.closest('tr');
        const id = row.dataset.id;

        fetch(`/delete_indicator/${program}/${id}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                } else {
                    alert('Error deleting record: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting record');
            });
    }
</script>

<style>
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 20px;
    }

    .edit-input {
        width: 60px;
    }

    .program-section {
        margin-top: 20px;
    }

    .btn {
        margin: 0 2px;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #2196F3;
        color: white;
    }

    .btn-primary:hover {
        background-color: #1976D2;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .btn-success {
        background-color: #4CAF50;
        color: white;
    }

    .btn-success:hover {
        background-color: #388E3C;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .btn-danger {
        background-color: #f44336;
        color: white;
    }

    .btn-danger:hover {
        background-color: #d32f2f;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
        transform: translateY(1px);
    }

    /* Table base styles */
    table.table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #ddd;
    }

    /* Table header with green background */
    table.table thead tr {
        background-color: #4CAF50;
        color: white;
    }

    /* Table cells */
    table.table th,
    table.table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
        transition: background-color 0.3s ease;
    }

    /* Hover effect on entire row */
    table.table tbody tr:hover {
        background-color: #f9f9f9;
    }

    /* Hover effect on individual cell */
    table.table tbody td:hover {
        background-color: #e6f2ff;
    }

    /* Optional: cursor pointer on hover for better UX */
    table.table tbody td {
        cursor: default;
    }
</style>
{% endblock %}